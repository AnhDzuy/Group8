<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        {% if repo.repo_id %}
        <h1 id="message">{{ 'Report for: name'|replace("name", repo.repo_name) }}</h1>
        {% for report in reports %}
        <h2>{{ report|replace("_", " ")|title }}</h2>
        {% for image in images[report] %}
        <div class="row row-cols-1 col-auto g-3" style="margin-bottom: 30px;">
            <div class="col">
                <div class="card img_placeholder d-flex justify-content-center align-items-center">
                    <div class="dot-flashing" id="{{ image['id'] }}"></div>
                </div>
                <div class="card-footer card-footer-wrap">
                    <small class="text-muted" id="desc_report_image_{{ image['id'] }}">{{ image['description'] }}</small>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endfor %}
        {% else %}
        <h1 id="message">{{ 'Repository id not found'|replace("id", repo_id) }}<h1>
        {% endif %}
    </div>
</div>
{% if repo.repo_id %}
<script type="text/javascript">
    /* Wait for cache response:
        This method queries the server from the client, asking for confirmation
        of which images are available on the server. The server will asynchronously
        download the requested images as the page is loading, then once the page
        loads, the client will query a locking endpoint on the server and wait
        for a response.
    */
    $.getJSON("{{ root }}requests/wait/{{ repo_id }}", function(image_data) {
        // var reports = JSON.parse('\{\{ reports | tojson \}\}');
        var image_placeholders = document.getElementsByClassName("img_placeholder");
        for(let index = 0; index < image_placeholders.length; ++index) {
            let div = image_placeholders[index].children[0];
            if(typeof div != "object") {
                continue;
            }
            div.classList.remove("dot-flashing");
            var backup = document.createElement("img");
            backup.setAttribute("src", "{{ url_for('static', filename= 'img/auggie_shrug.png') }}");
            backup.setAttribute("class", "img-fluid");
            if(image_data['images'][div.id]['exists']) {
                var image = document.createElement("img");
                image_path = "{{ root }}static/" + image_data['images'][div.id]['path'];
                image.setAttribute("src", image_path);
                image.setAttribute("class", "img-fluid");
                image.setAttribute("onclick", "displayModal(\"report_image_" + div.id + "\")")
                image.setAttribute("id", "report_image_" + div.id)
                div.appendChild(image);
            } else {
                div.appendChild(backup);
            }
        }
    });
</script>
{% endif %}
<div class="modal" id="viewImg" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-body">
                <div id="imgViewer" style="overflow-x: scroll;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- The Modal -->
<div id="imageModal" class="modal">
  <!-- <span class="close">&times;</span> -->
  <img class="modal-content" id="img01">
  <div id="caption"></div>
</div>

<script>
    function displayModal(id) {
        // Get the modal
        var modal = document.getElementById("imageModal");

        // Get the image and insert it inside the modal - use its "alt" text as a caption
        var img = document.getElementById(id);
        var modalImg = document.getElementById("img01");
        var captionText = document.getElementById("caption");

        var description = document.getElementById("desc_" + id)

        modal.style.display = "block";
        modalImg.src = img.src;
        captionText.innerHTML = description.innerHTML;

        // Get the <span> element that closes the modal
        // var span = document.getElementsByClassName("close")[0];

        // When the user clicks on <span> (x), close the modal
        modal.onclick = function() {
          modal.style.display = "none";
        }
    }
    window.addEventListener("keydown", function(event) {
	if(document.getElementById("imageModal").style.display == "block") {
	    if(event.code == "Escape") {
		document.getElementById("imageModal").style.display = "none"
	    }
	}
    }, true);
</script>
